<!DOCTYPE html>
<html>
  <head>
    <title>Wifi Dotmatrix Display</title>
    <script>
      function submitModeOfOperation() {
        let strLine = "";
        const nocache = "/&nocache=" + Math.random() * 1000000;
        const form = document.getElementById("operation_mode_form");
        const request = new XMLHttpRequest();

        if (form["message-checkbox"].checked) {
          const message = form["message-input"].value;
          if (message.trim() === "") {
            alert("Message cannot be empty when selected.");
            return;
          }
          strLine += "/&MSG=" + message;
        }
        if (form["clock-checkbox"].checked) {
          strLine += "/&CLK";
        }
        if (form["date-checkbox"].checked) {
          strLine += "/&DATE";
        }
        if (form["weather-checkbox"].checked) {
          strLine += "/&WEATHER";
        }
        if (form["snake-checkbox"].checked) {
          strLine += "/&SNAKE";
        }

        request.open("GET", strLine + nocache, false);
        try {
          request.send(null);
        } catch (e) {
          console.log(e);
        }
      }

      function setCntl(settings) {
        const strLine = `&CNTL=${encodeURI(JSON.stringify(settings))}`;
        const nocache = "/&nocache=" + Math.random() * 1000000;
        const request = new XMLHttpRequest();

        request.open("GET", strLine + nocache, false);
        request.send(null);
      }

      function populateTimezones() {
        const timezoneElem = document.getElementById("timezone");
        fetch("https://worldtimeapi.org/api/timezone")
          .then((response) => response.json())
          .then((data) => {
            data.forEach((timezone) => {
              const opt = document.createElement("option");
              opt.value = timezone;
              opt.innerHTML = timezone;
              timezoneElem.appendChild(opt);
            });
          })
          .catch((error) => console.error("Error fetching timezones:", error));
      }

      function getSettings() {
        fetch("/&SETT")
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("timezone").value = data.timezone;
            document.getElementById("brightness").value = data.brightness;
            document.getElementById("weather-latitude").value = data.latitude;
            document.getElementById("weather-longitude").value = data.longitude;
            document.querySelector(
              `input[name=weather-units][value=${data.weatherUnits}]`
            ).checked = true;
            data.activeCards.forEach((card) => {
              document.getElementById(
                `${card.toLowerCase()}-checkbox`
              ).checked = true;
            });
          })
          .catch((error) => console.error("Error fetching settings:", error));
      }

      window.onload = function () {
        populateTimezones();
        getSettings();
      };
    </script>
  </head>
  <body>
    <h1>Set Mode Of Operation</h1>
    <form
      id="operation_mode_form"
      onsubmit="submitModeOfOperation(); return false;"
    >
      <fieldset>
        <legend>Select Mode</legend>
        <input type="checkbox" id="message-checkbox" name="operation-mode" />
        <label for="message-checkbox">
          Message:
          <input
            type="text"
            id="message-input"
            name="message-input"
            maxlength="255"
          />
        </label>
        <br /><br />
        <input type="checkbox" id="clock-checkbox" name="operation-mode" />
        <label for="clock-checkbox">Clock</label>
        <br /><br />
        <input type="checkbox" id="date-checkbox" name="operation-mode" />
        <label for="date-checkbox">Date</label>
        <br /><br />
        <input type="checkbox" id="weather-checkbox" name="operation-mode" />
        <label for="weather-checkbox">Weather</label>
        <br /><br />
        <input type="checkbox" id="snake-checkbox" name="operation-mode" />
        <label for="snake-checkbox">Snake</label>
        <br /><br />
      </fieldset>
      <input type="submit" value="Submit" />
    </form>

    <h1>Settings</h1>
    <form id="settings_form" onsubmit="setCntl(); return false;">
      <fieldset>
        <legend>General Settings</legend>
        <label for="timezone">
          Timezone:
          <select id="timezone"></select>
        </label>
        <input
          type="submit"
          value="Set"
          onsubmit="setCntl({ timezone: document.getElementById('timezone').value }); return false;"
        />
        <br /><br />
        <label for="brightness">
          Brightness:
          <input
            type="number"
            id="brightness"
            name="brightness"
            min="0"
            max="15"
            required
          />
        </label>
        <input
          type="submit"
          value="Set"
          onsubmit="setCntl({ brightness: document.getElementById('brightness').value }); return false;"
        />
      </fieldset>
      <br />
      <fieldset>
        <legend>Weather Settings</legend>
        <label for="weather-latitude">
          Weather Location:
          <label
            >Latitude:
            <input
              id="weather-latitude"
              name="weather-latitude"
              maxlength="32"
              required
          /></label>
          <label
            >Longitude:
            <input
              id="weather-longitude"
              name="weather-longitude"
              maxlength="32"
              required
          /></label>
        </label>
        <input
          type="submit"
          value="Set"
          onsubmit="setCntl({ latitude: document.getElementById('weather-latitude').value, longitude: document.getElementById('weather-longitude').value }); return false;"
        />
        <br /><br />
        <label>
          Weather Units:
          <input
            type="radio"
            id="celsius-radio"
            name="weather-units"
            value="c"
            required
          /><label for="celsius-radio">Celsius</label>
          <input
            type="radio"
            id="fahrenheit-radio"
            name="weather-units"
            value="f"
            required
          /><label for="fahrenheit-radio">Fahrenheit</label>
        </label>
        <input
          type="submit"
          value="Set"
          onsubmit="setCntl({ weatherUnits: document.querySelector('input[name=weather-units]:checked').value }); return false;"
        />
      </fieldset>
    </form>
  </body>
</html>
